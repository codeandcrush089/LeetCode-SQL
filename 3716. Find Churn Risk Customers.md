# Problem 3716. Find Churn Risk Customers
![Medium](https://img.shields.io/badge/Level-Medium-yellow)

```sql
WITH
    user_with_last_event AS (
        SELECT
            s.*,
            ROW_NUMBER() OVER (
                PARTITION BY user_id
                ORDER BY event_date DESC, event_id DESC
            ) AS rn
        FROM subscription_events s
    ),
    user_history AS (
        SELECT
            user_id,
            MIN(event_date) AS start_date,
            MAX(event_date) AS last_event_date,
            MAX(monthly_amount) AS max_historical_amount,
            SUM(
                CASE
                    WHEN event_type = 'downgrade' THEN 1
                    ELSE 0
                END
            ) AS downgrade_count
        FROM subscription_events
        GROUP BY user_id
    ),
    latest_event AS (
        SELECT
            user_id,
            event_type AS last_event_type,
            plan_name AS current_plan,
            monthly_amount AS current_monthly_amount
        FROM user_with_last_event
        WHERE rn = 1
    )
SELECT
    l.user_id,
    l.current_plan,
    l.current_monthly_amount,
    h.max_historical_amount,
    DATEDIFF(h.last_event_date, h.start_date) AS days_as_subscriber
FROM
    latest_event l
    JOIN user_history h ON l.user_id = h.user_id
WHERE
    l.last_event_type <> 'cancel'
    AND h.downgrade_count >= 1
    AND l.current_monthly_amount < 0.5 * h.max_historical_amount
    AND DATEDIFF(h.last_event_date, h.start_date) >= 60
ORDER BY days_as_subscriber DESC, l.user_id ASC;
```
## üßê Query Explanation
* `user_with_last_event` ‚Üí
  Adds a row number per `user_id` ordered by **latest event_date + event_id**, so `rn = 1` = **most recent event** for each user.

* `user_history` ‚Üí Per `user_id`, calculates:

  * `start_date` ‚Üí **first event date**
  * `last_event_date` ‚Üí **most recent event date**
  * `max_historical_amount` ‚Üí **highest monthly_amount ever**
  * `downgrade_count` ‚Üí how many times event_type = **'downgrade'**

* `latest_event` ‚Üí Picks only `rn = 1` from first CTE = **each user‚Äôs latest event**, with:

  * `last_event_type`
  * `current_plan`
  * `current_monthly_amount`

* Final `SELECT`:

  * Joins `latest_event` (`l`) with `user_history` (`h`) on `user_id`.
  * `DATEDIFF(h.last_event_date, h.start_date)` ‚Üí total **days as subscriber**.

* `WHERE` filters users to:

  * Not canceled: `last_event_type <> 'cancel'`
  * Have at least one downgrade in history: `downgrade_count >= 1`
  * Current price is **less than 50%** of their **max historical price**
    `current_monthly_amount < 0.5 * max_historical_amount`
  * Have been a subscriber for **at least 60 days**.

* `ORDER BY days_as_subscriber DESC, user_id ASC` ‚Üí Longest subscribers first, then by user_id.

