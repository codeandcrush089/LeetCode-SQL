# Problem  3673: Find Zombie Sessions
![Hard](https://img.shields.io/badge/Level-Hard-red)

```sql
SELECT
    session_id,
    user_id,
    -- CRITERION 1: Calculate duration in minutes (Max timestamp - Min timestamp)
    TIMESTAMPDIFF(MINUTE, MIN(event_timestamp), MAX(event_timestamp)) AS session_duration_minutes,
    
    -- CRITERION 2 & 3: Count of scroll events
    SUM(CASE WHEN event_type = 'scroll' THEN 1 ELSE 0 END) AS scroll_count
    -- Removed 'click_count' as it is not in the required output columns.
FROM
    app_events
GROUP BY
    session_id, user_id
HAVING
    -- CRITERION 1: Session duration is more than 30 minutes
    TIMESTAMPDIFF(MINUTE, MIN(event_timestamp), MAX(event_timestamp)) > 30
    
    -- CRITERION 2: Has at least 5 scroll events
    AND SUM(CASE WHEN event_type = 'scroll' THEN 1 ELSE 0 END) >= 5
    
    -- CRITERION 3: The click-to-scroll ratio is less than 0.20
    AND (
        SUM(CASE WHEN event_type = 'click' THEN 1 ELSE 0 END) * 1.0 / 
        NULLIF(SUM(CASE WHEN event_type = 'scroll' THEN 1 ELSE 0 END), 0)
    ) < 0.20
    
    -- CRITERION 4: No purchases were made during the session
    AND SUM(CASE WHEN event_type = 'purchase' THEN 1 ELSE 0 END) = 0
    
ORDER BY
    scroll_count DESC,
    session_id ASC;
```
---
## ðŸ§ Query Explanation
* `GROUP BY session_id, user_id` â†’ Work **per session per user**.

* `TIMESTAMPDIFF(MINUTE, MIN(event_timestamp), MAX(event_timestamp))`
  â†’ Time between first and last event = **session duration in minutes**.

* `SUM(CASE WHEN event_type = 'scroll' THEN 1 ELSE 0 END) AS scroll_count`
  â†’ **Total scroll events** in that session.

**HAVING filters (conditions for keeping a session):**

1. Duration > 30 minutes
   â†’ `TIMESTAMPDIFF(...) > 30`

2. At least 5 scrolls
   â†’ `SUM(event_type = 'scroll') >= 5`

3. Click-to-scroll ratio < 0.20
   â†’ clicks / scrolls `< 0.20` (using `NULLIF` to avoid divide-by-zero).

4. No purchases
   â†’ `SUM(event_type = 'purchase') = 0`

`ORDER BY scroll_count DESC, session_id ASC`
â†’ Sessions with **most scrolls first**, then by session_id.

