# Problem 3521: Find Product Recommendation Pairs
![Medium](https://img.shields.io/badge/Level-Medium-yellow?style=for-the-badge) [![Problem Link](https://img.shields.io/badge/LeetCode-Link-orange?style=for-the-badge&logo=leetcode)](https://leetcode.com/problems/find-product-recommendation-pairs/description/)


```sql
WITH CoPurchasedPairs AS (
    -- 1. Identify all distinct product pairs bought by the same user.
    --    The join condition ensures that product1_id < product2_id to eliminate duplicates (e.g., (102, 101))
    --    and self-pairs (e.g., (101, 101)).
    SELECT
        p1.user_id,
        p1.product_id AS product1_id,
        p2.product_id AS product2_id
    FROM
        ProductPurchases p1
    INNER JOIN
        ProductPurchases p2
        ON p1.user_id = p2.user_id AND p1.product_id < p2.product_id
),
FrequentPairs AS (
    -- 2. Count the number of unique customers for each product pair.
    --    Filter the pairs that were purchased by at least 3 different customers.
    SELECT
        product1_id,
        product2_id,
        COUNT(DISTINCT user_id) AS customer_count
    FROM
        CoPurchasedPairs
    GROUP BY
        product1_id,
        product2_id
    HAVING
        COUNT(DISTINCT user_id) >= 3
)
-- 3. Retrieve the category information for each product in the pair and format the final output.
SELECT
    fp.product1_id,
    fp.product2_id,
    pi1.category AS product1_category,
    pi2.category AS product2_category,
    fp.customer_count
FROM
    FrequentPairs fp
-- Join 1: Get category for product1_id
INNER JOIN
    ProductInfo pi1
    ON fp.product1_id = pi1.product_id
-- Join 2: Get category for product2_id
INNER JOIN
    ProductInfo pi2
    ON fp.product2_id = pi2.product_id
ORDER BY
    fp.customer_count DESC,
    fp.product1_id ASC,
    fp.product2_id ASC;
```
---
## üßê Query Explanation

1.  **`CoPurchasedPairs` CTE:**

      * It performs a **self-join** on the `ProductPurchases` table (`p1` and `p2`).
      * The join condition `p1.user_id = p2.user_id` links purchases made by the **same customer**.
      * The crucial condition `p1.product_id < p2.product_id` ensures that:
          * We only get **unique pairs** (e.g., we get `(101, 102)` but not `(102, 101)`).
          * We exclude self-purchases (a product paired with itself).

2.  **`FrequentPairs` CTE:**

      * Groups the results by the identified `product1_id` and `product2_id`.
      * Uses `COUNT(DISTINCT user_id)` to accurately count the **number of unique customers** who purchased both products in the pair.
      * The `HAVING COUNT(DISTINCT user_id) >= 3` clause filters the results to keep only the pairs purchased by **at least 3 different customers**, as required for the recommendation feature.

3.  **Final `SELECT` Statement:**

      * Joins the `FrequentPairs` with the `ProductInfo` table **twice** (aliased as `pi1` and `pi2`) to fetch the `category` for both `product1_id` and `product2_id`.
      * Orders the final result according to the requirements: `customer_count` descending, then `product1_id` ascending, and finally `product2_id` ascending.
