# Problem 3626: Find Stores with Inventory Imbalance
![Medium](https://img.shields.io/badge/Level-Medium-yellow)

```sql
WITH
    T AS (
        SELECT
            store_id,
            product_name,
            quantity,
            RANK() OVER (
                PARTITION BY store_id
                ORDER BY price DESC, quantity DESC
            ) rk1,
            RANK() OVER (
                PARTITION BY store_id
                ORDER BY price, quantity DESC
            ) rk2,
            COUNT(1) OVER (PARTITION BY store_id) cnt
        FROM inventory
    ),
    P1 AS (
        SELECT *
        FROM T
        WHERE rk1 = 1 AND cnt >= 3
    ),
    P2 AS (
        SELECT *
        FROM T
        WHERE rk2 = 1
    )
SELECT
    s.store_id store_id,
    store_name,
    location,
    p1.product_name most_exp_product,
    p2.product_name cheapest_product,
    ROUND(p2.quantity / p1.quantity, 2) imbalance_ratio
FROM
    P1 p1
    JOIN P2 p2 ON p1.store_id = p2.store_id AND p1.quantity < p2.quantity
    JOIN stores s ON p1.store_id = s.store_id
ORDER BY imbalance_ratio DESC, store_name;
```
---
## ðŸ§ Query Explanation


* **`T` CTE**

  * Reads `inventory` and computes per `store_id`:

    * `rk1`: rank by `price DESC, quantity DESC` â†’ **most expensive product(s)** get `rk1 = 1`.
    * `rk2`: rank by `price ASC, quantity DESC` â†’ **cheapest product(s)** get `rk2 = 1`.
    * `cnt`: total number of inventory rows per store.

* **`P1` CTE**

  * Keeps rows from `T` where `rk1 = 1` **and** `cnt >= 3` â†’ pick the most expensive product **only for stores with at least 3 items**.

* **`P2` CTE**

  * Keeps rows where `rk2 = 1` â†’ the **cheapest product** per store.

* **Final SELECT**

  * Joins `P1` and `P2` for the **same store**, but only when `p1.quantity < p2.quantity` â†’ the most-expensive product has **fewer units than** the cheapest product (significant inventory imbalance).
  * Selects store info plus:

    * `most_exp_product` (from `p1`)
    * `cheapest_product` (from `p2`)
    * `imbalance_ratio = ROUND(p2.quantity / p1.quantity, 2)` â†’ how many times larger the cheap-product stock is compared to the expensive-product stock.
  * `ORDER BY imbalance_ratio DESC, store_name` â†’ biggest imbalances first, then by store name.
