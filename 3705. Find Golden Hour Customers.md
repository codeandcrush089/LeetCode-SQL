# Problem 3705: Find Golden Hour Customers
![Medium](https://img.shields.io/badge/Level-Medium-yellow?style=for-the-badge) [![Problem Link](https://img.shields.io/badge/LeetCode-Link-orange?style=for-the-badge&logo=leetcode)](https://leetcode.com/problems/find-golden-hour-customers/)

```sql
SELECT
    customer_id,
    COUNT(order_id) AS total_orders,
    -- (Count Peak Orders / Total Orders) * 100
    ROUND(
        (SUM(CASE WHEN HOUR(order_timestamp) BETWEEN 11 AND 13 OR HOUR(order_timestamp) BETWEEN 18 AND 20 THEN 1 ELSE 0 END) * 100.0) / COUNT(order_id),
        0
    ) AS peak_hour_percentage,
    -- Average rating for non-NULL ratings, rounded to 2 decimal places
    ROUND(AVG(order_rating), 2) AS average_rating
FROM
    restaurant_orders
GROUP BY
    customer_id
HAVING
    -- CRITERION 1: Made at least 3 orders
    COUNT(order_id) >= 3
    
    -- CRITERION 2: At least 60% of their orders are during peak hours (11:00-14:00 or 18:00-21:00)
    -- Peak hours are 11 (11:00:00) to 13 (13:59:59) and 18 (18:00:00) to 20 (20:59:59)
    AND (SUM(CASE WHEN HOUR(order_timestamp) BETWEEN 11 AND 13 OR HOUR(order_timestamp) BETWEEN 18 AND 20 THEN 1 ELSE 0 END) * 100.0) / COUNT(order_id) >= 60
    
    -- CRITERION 3: Their average rating for rated orders is at least 4.0
    AND AVG(order_rating) >= 4.0
    
    -- CRITERION 4: Have rated at least 50% of their orders
    AND (SUM(CASE WHEN order_rating IS NOT NULL THEN 1 ELSE 0 END) * 100.0) / COUNT(order_id) >= 50
ORDER BY
    average_rating DESC,
    customer_id DESC;
```
---
## ðŸ§ Query Explanation
* `COUNT(order_id) AS total_orders` â†’ Total number of orders per customer.

* `SUM(CASE WHEN HOUR(order_timestamp) BETWEEN 11 AND 13 OR 18 AND 20 THEN 1 ELSE 0 END)`
  â†’ Counts how many orders were placed in **peak hours** (lunch + dinner).

* `ROUND((that_count * 100.0) / COUNT(order_id), 0) AS peak_hour_percentage`
  â†’ Percentage of the customerâ€™s orders that are in **peak hours**.

* `ROUND(AVG(order_rating), 2) AS average_rating`
  â†’ Average rating given by the customer (ignoring NULLs).

**HAVING conditions (filters):**

1. `COUNT(order_id) >= 3` â†’ Customer has **at least 3 orders**.
2. Peak orders â‰¥ 60% â†’ They **mostly order in peak hours**.
3. `AVG(order_rating) >= 4.0` â†’ Their **average rating is at least 4 stars**.
4. Rated orders â‰¥ 50% â†’ They have **rated at least half of their orders**.

`ORDER BY average_rating DESC, customer_id DESC` â†’ Best raters first, then higher customer_id.
