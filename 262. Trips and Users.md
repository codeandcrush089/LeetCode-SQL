# Problem 262: Trips and Users
![Hard](https://img.shields.io/badge/Level-Hard-red?style=for-the-badge) [![Problem Link](https://img.shields.io/badge/LeetCode-Link-orange?style=for-the-badge&logo=leetcode)](https://leetcode.com/problems/trips-and-users/description/)

```sql
SELECT
    T.request_at AS Day,
    
    ROUND(
        -- Numerator: Sum of 1 for cancelled trips, 0 otherwise (Conditional Aggregation)
        SUM(CASE WHEN T.status IN ('cancelled_by_driver', 'cancelled_by_client') THEN 1 ELSE 0 END)
        /
        -- Denominator: Total count of trips in the filtered group (i.e., total unbanned trips)
        COUNT(T.id)
    , 2) AS "Cancellation Rate"
FROM
    Trips T
JOIN
    Users U_client ON T.client_id = U_client.users_id -- Join to get client status
JOIN
    Users U_driver ON T.driver_id = U_driver.users_id -- Join to get driver status
WHERE
    -- 1. Date Range Filter: Only include trips between '2013-10-01' and '2013-10-03'
    T.request_at BETWEEN '2013-10-01' AND '2013-10-03'
    AND
    -- 2. Unbanned Filter: Both client AND driver must NOT be banned
    U_client.banned = 'No'
    AND
    U_driver.banned = 'No'
GROUP BY
    T.request_at
HAVING
    -- 3. The problem statement implies we only need days with at least one trip,
    -- but since we are filtering the trips first, the COUNT() will naturally be >= 1 for remaining groups.
    COUNT(T.id) >= 1
ORDER BY
    Day;
```
---

## ðŸ§ Query Explanation

### **1. `FROM Trips T`**

Uses the `Trips` table as the base data (each row = one trip).



### **2. Join with Users table (twice)**

```sql
JOIN Users U_client ON T.client_id = U_client.users_id
JOIN Users U_driver ON T.driver_id = U_driver.users_id
```

* First join â†’ checks **client** ban status
* Second join â†’ checks **driver** ban status



### **3. Date filter**

```sql
T.request_at BETWEEN '2013-10-01' AND '2013-10-03'
```

Keeps only trips requested in the given date range.



### **4. Unbanned users filter**

```sql
U_client.banned = 'No'
AND U_driver.banned = 'No'
```

Ensures **both client and driver are not banned**.



### **5. Group by day**

```sql
GROUP BY T.request_at
```

Aggregates trips **per day**.



### **6. Count cancelled trips**

```sql
SUM(
  CASE
    WHEN T.status IN ('cancelled_by_driver', 'cancelled_by_client')
    THEN 1 ELSE 0
  END
)
```

Counts how many trips were **cancelled** on each day.



### **7. Count total trips**

```sql
COUNT(T.id)
```

Counts **all valid trips** (after filtering) per day.



### **8. Calculate cancellation rate**

```sql
ROUND(cancelled_trips / total_trips, 2)
```

Computes the **daily cancellation rate**, rounded to 2 decimals.



### **9. `HAVING COUNT(T.id) >= 1`**

Keeps only days that have **at least one valid trip**.



### **10. `ORDER BY Day`**

Sorts results **by date**.

