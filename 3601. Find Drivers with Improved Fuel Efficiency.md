# Problem 3601: Find Drivers with Improved Fuel Efficiency
![Medium](https://img.shields.io/badge/Level-Medium-yellow)

```sql
WITH
    T AS (
        SELECT
            driver_id,
            AVG(distance_km / fuel_consumed) half_avg,
            CASE
                WHEN MONTH(trip_date) <= 6 THEN 1
                ELSE 2
            END half
        FROM trips
        GROUP BY driver_id, half
    )
SELECT
    t1.driver_id,
    d.driver_name,
    ROUND(t1.half_avg, 2) first_half_avg,
    ROUND(t2.half_avg, 2) second_half_avg,
    ROUND(t2.half_avg - t1.half_avg, 2) efficiency_improvement
FROM
    T t1
    JOIN T t2 ON t1.driver_id = t2.driver_id AND t1.half < t2.half AND t1.half_avg < t2.half_avg
    JOIN drivers d ON t1.driver_id = d.driver_id
ORDER BY efficiency_improvement DESC, d.driver_name;
```
---
## ðŸ§ Query Explanation
* **`T` CTE**

  * Groups `trips` by `driver_id` and `half` (half = `1` for months Janâ€“Jun, `2` for Julâ€“Dec).
  * Computes `half_avg = AVG(distance_km / fuel_consumed)` â†’ average **km per unit fuel** for that half.

* **Main query**

  * Joins `T` to itself as `t1` (first half) and `t2` (second half) on `driver_id` with `t1.half < t2.half` â†’ pairs first-half and second-half rows for the same driver.
  * Additional condition `t1.half_avg < t2.half_avg` â†’ keeps only drivers whose **fuel efficiency improved** in the second half.
  * Joins `drivers` to get `driver_name`.
  * `ROUND(..., 2)` â†’ shows averages and improvement rounded to 2 decimals.
  * `efficiency_improvement = second_half_avg - first_half_avg`.

* **ORDER BY**

  * Sorts drivers by **largest efficiency improvement first**, then by driver name.
