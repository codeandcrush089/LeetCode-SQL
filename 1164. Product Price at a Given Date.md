# Problem 1164: Product Price at a Given Date
![Medium](https://img.shields.io/badge/Level-Medium-yellow)

```sql
SELECT
    p_all.product_id,
    -- If a relevant price change was found (t2.new_price is NOT NULL), use that price.
    -- If no change was found on or before the target date, use the initial price of 10.
    COALESCE(t2.new_price, 10) AS price
FROM
    -- 1. Get all unique product IDs that have ever appeared in the table
    (SELECT DISTINCT product_id FROM Products) AS p_all
LEFT JOIN
    (
        -- 2. Find the single latest price record for each product that occurred on or before '2019-08-16'
        SELECT
            p.product_id,
            p.new_price
        FROM
            Products p
        INNER JOIN
            (
                -- Find the maximum (latest) change_date for each product <= 2019-08-16
                SELECT
                    product_id,
                    MAX(change_date) AS max_date
                FROM
                    Products
                WHERE
                    change_date <= '2019-08-16'
                GROUP BY
                    product_id
            ) AS latest_change ON p.product_id = latest_change.product_id
                                AND p.change_date = latest_change.max_date
    ) AS t2 ON p_all.product_id = t2.product_id;
```

---
## ðŸ§ Query Explanation


### 1. Outer `SELECT`

```sql
SELECT
    p_all.product_id,
    COALESCE(t2.new_price, 10) AS price
```

* For each product:

  * Shows the **product_id**.
  * Shows the **price as of '2019-08-16'**:

    * Uses `t2.new_price` if available.
    * If no price change before that date, uses default **10** via `COALESCE`.


### 2. Subquery `p_all`

```sql
(SELECT DISTINCT product_id FROM Products) AS p_all
```

* Gets **all unique product IDs** that ever appeared in the `Products` table.
* Ensures **every product** is included, even if it has no price change before the target date.


### 3. `LEFT JOIN ... ON p_all.product_id = t2.product_id`

* Left joins **all products** (`p_all`) with their **latest valid price record** (`t2`).
* If a product has **no matching record in `t2`**, it still appears, but `t2.new_price` will be `NULL` â†’ replaced by `10`.


### 4. Subquery `t2`

```sql
(
    SELECT
        p.product_id,
        p.new_price
    FROM
        Products p
    INNER JOIN
        (
            SELECT
                product_id,
                MAX(change_date) AS max_date
            FROM
                Products
            WHERE
                change_date <= '2019-08-16'
            GROUP BY
                product_id
        ) AS latest_change
        ON p.product_id = latest_change.product_id
       AND p.change_date = latest_change.max_date
) AS t2
```

#### 4.1 Inner-most subquery `latest_change`

```sql
SELECT
    product_id,
    MAX(change_date) AS max_date
FROM
    Products
WHERE
    change_date <= '2019-08-16'
GROUP BY
    product_id
```

* For each product:

  * Finds the **latest change_date** that is **on or before '2019-08-16'**.
  * Returns one row per product: `product_id`, `max_date`.

#### 4.2 Join with `Products p`

```sql
FROM Products p
INNER JOIN latest_change
ON p.product_id = latest_change.product_id
AND p.change_date = latest_change.max_date
```

* Picks the **exact price record** (`p.new_price`) corresponding to that **latest valid change_date** for each product.
* So `t2` contains:

  * `product_id`
  * `new_price` (latest price as of '2019-08-16').


