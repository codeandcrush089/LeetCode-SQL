# Problem 3497: Analyze Subscription Conversion 
![Medium](https://img.shields.io/badge/Level-Medium-yellow)

```sql
WITH
    T AS (
        SELECT user_id, activity_type, ROUND(SUM(activity_duration) / COUNT(1), 2) duration
        FROM UserActivity
        WHERE activity_type != 'cancelled'
        GROUP BY user_id, activity_type
    ),
    F AS (
        SELECT user_id, duration trial_avg_duration
        FROM T
        WHERE activity_type = 'free_trial'
    ),
    P AS (
        SELECT user_id, duration paid_avg_duration
        FROM T
        WHERE activity_type = 'paid'
    )
SELECT user_id, trial_avg_duration, paid_avg_duration
FROM
    F
    JOIN P USING (user_id)
ORDER BY 1;

```
---
## üßê Query Explanation

* **`T` CTE**

  * Groups user activity by `user_id` and `activity_type`.
  * For each group, computes the **average activity duration**:
    `SUM(activity_duration) / COUNT(*)`, rounded to 2 decimals.
  * Excludes cancelled activities.

* **`F` CTE**

  * Extracts each user‚Äôs **average free_trial duration**.

* **`P` CTE**

  * Extracts each user‚Äôs **average paid duration**.

* **Final SELECT**

  * Joins `F` and `P` so only users who have **both** free_trial and paid activities appear.
  * Returns:

    * `user_id`
    * `trial_avg_duration`
    * `paid_avg_duration`
  * Sorted by user_id.

‚úÖ **In short:**
This query compares each user's **average free-trial activity duration** with their **average paid activity duration**, showing only users who have data for both.
