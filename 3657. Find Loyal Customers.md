# Problem 3657: Find Loyal Customers
![Medium](https://img.shields.io/badge/Level-Medium-yellow?style=for-the-badge) [![Problem Link](https://img.shields.io/badge/LeetCode-Link-orange?style=for-the-badge&logo=leetcode)](https://leetcode.com/problems/find-loyal-customers/)

```sql
SELECT customer_id
FROM customer_transactions
GROUP BY 1
HAVING
    COUNT(1) >= 3
    AND SUM(transaction_type = 'refund') / COUNT(1) < 0.2
    AND DATEDIFF(MAX(transaction_date), MIN(transaction_date)) >= 30
ORDER BY 1;
```
---
## ðŸ§ Query Explanation


* `COUNT(1) >= 3`
  â†’ Customer must have **at least 3 transactions**.

* `SUM(transaction_type = 'refund') / COUNT(1) < 0.2`
  â†’ Refunds must be **less than 20%** of all transactions (i.e., mostly regular purchases).
  â†’ `SUM(transaction_type = 'refund')` counts refunds because TRUE = 1.

* `DATEDIFF(MAX(transaction_date), MIN(transaction_date)) >= 30`
  â†’ Transactions must span at least **30 days** â†’ shows long-term activity.

* `GROUP BY customer_id`
  â†’ Apply the rules per customer.

* `ORDER BY customer_id`
  â†’ Sort ascending.

