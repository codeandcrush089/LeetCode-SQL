# Problem 3482: Analyze Organization Hierarchy
![Hard](https://img.shields.io/badge/Level-Hard-red)

```sql
WITH RECURSIVE Hierarchy AS (
    -- Anchor Member (CEO - Level 1)
    SELECT
        employee_id,
        employee_name,
        manager_id,
        salary,
        1 AS level
    FROM
        Employees
    WHERE
        manager_id IS NULL -- The top-level manager (CEO)

    UNION ALL

    -- Recursive Member (All other employees)
    SELECT
        e.employee_id,
        e.employee_name,
        e.manager_id,
        e.salary,
        h.level + 1 AS level
    FROM
        Employees e
    INNER JOIN
        Hierarchy h ON e.manager_id = h.employee_id
),
TeamMetrics AS (
    -- Step 2: Calculate Team Size (count of direct and indirect reports) and Budget (sum of salaries)
    SELECT
        e.employee_id AS manager_id,
        COUNT(h.employee_id) AS team_size,
        SUM(h.salary) AS reports_salary_budget
    FROM
        Employees e
    INNER JOIN
        Hierarchy h ON h.manager_id = e.employee_id -- Link employees (reports) back to their managers
    GROUP BY
        e.employee_id

    UNION ALL
    
    -- Include managers who have reports who themselves are managers (for indirect reports)
    SELECT
        e.manager_id,
        tm.team_size,
        tm.reports_salary_budget
    FROM
        TeamMetrics tm
    INNER JOIN
        Employees e ON e.employee_id = tm.manager_id
    WHERE
        e.manager_id IS NOT NULL
)
-- Step 3: Final Aggregation, Calculation of Total Budget, and Ordering
SELECT
    h.employee_id,
    h.employee_name,
    h.level,
    -- Team Size: Sum of all reports (direct and indirect) under the employee
    COALESCE(SUM(tm.team_size), 0) AS team_size, 
    -- Budget: Employee's own salary + sum of all reports' salaries
    h.salary + COALESCE(SUM(tm.reports_salary_budget), 0) AS budget
FROM
    Hierarchy h
LEFT JOIN
    TeamMetrics tm ON h.employee_id = tm.manager_id
GROUP BY
    h.employee_id, h.employee_name, h.level, h.salary -- Include salary in GROUP BY if database requires it
ORDER BY
    level ASC,
    budget DESC,
    employee_name ASC;
```
---
## üßê Query Explanation


* **Hierarchy CTE**

  * Builds the **org tree** using a recursive CTE.
  * Starts from the **CEO** (`manager_id IS NULL`, `level = 1`).
  * Recursively adds employees whose `manager_id = previous employee_id`, increasing `level` each time ‚Üí gives **each employee‚Äôs level in the hierarchy**.

* **TeamMetrics CTE**

  * First part: for each `manager_id`, counts how many employees in `Hierarchy` have that manager ‚Üí

    * `team_size` = number of **direct reports (and via recursion usage, later indirect)**
    * `reports_salary_budget` = **sum of salaries of those reports**.
  * Second part (UNION ALL): tries to **propagate metrics upward** so higher managers aggregate data from managers below them.

* **Final SELECT**

  * Joins `Hierarchy` with `TeamMetrics` on `employee_id = manager_id`.
  * `team_size` = `SUM(tm.team_size)` ‚Üí total **direct + indirect reports** under that employee.
  * `budget` = `own salary + SUM(reports_salary_budget)` ‚Üí **total salary cost of the whole team**, including the manager.
  * Ordered by **level (top to bottom)**, then **budget (high to low)**, then **name**.


