# Problem 3554: Find Category Recommendation Pairs
![Hard](https://img.shields.io/badge/Level-Hard-red?style=for-the-badge) [![Problem Link](https://img.shields.io/badge/LeetCode-Link-orange?style=for-the-badge&logo=leetcode)](https://leetcode.com/problems/find-category-recommendation-pairs/)

```sql
WITH UserCategories AS (
    -- Step 1: Find all unique categories purchased by each user.
    SELECT DISTINCT
        p.user_id,
        i.category
    FROM
        ProductPurchases p
    INNER JOIN
        ProductInfo i ON p.product_id = i.product_id
),
CategoryPairs AS (
    -- Step 2: Generate all unique, ordered category pairs purchased by the same user.
    -- This step efficiently handles the category1 < category2 constraint.
    SELECT
        uc1.category AS category1,
        uc2.category AS category2,
        uc1.user_id
    FROM
        UserCategories uc1
    INNER JOIN
        UserCategories uc2
        ON uc1.user_id = uc2.user_id
    WHERE
        -- Enforce the ordering requirement: category1 < category2
        uc1.category < uc2.category
)
-- Step 3: Count the number of unique customers for each reportable category pair.
SELECT
    category1,
    category2,
    COUNT(DISTINCT user_id) AS customer_count
FROM
    CategoryPairs
GROUP BY
    category1,
    category2
HAVING
    -- A pair is reportable if at least 3 different customers purchased from both.
    COUNT(DISTINCT user_id) >= 3
ORDER BY
    customer_count DESC,
    category1 ASC,
    category2 ASC;
```
---
## üßê Query Explanation
* **`UserCategories` CTE**

  * Gets **unique (user_id, category)** pairs ‚Üí which categories each user has ever purchased.

* **`CategoryPairs` CTE**

  * Self-joins `UserCategories` on `user_id` to find **pairs of categories bought by the same user**.
  * `uc1.category < uc2.category` ensures:

    * No duplicates like `(A,B)` and `(B,A)`
    * No pairs like `(A,A)`.

* **Final SELECT**

  * `COUNT(DISTINCT user_id)` ‚Üí Counts **how many different customers** bought **both categories** in the pair.
  * `HAVING COUNT(DISTINCT user_id) >= 3` ‚Üí Keep only **popular pairs** (at least 3 customers).
  * `ORDER BY customer_count DESC, category1, category2` ‚Üí Most common pairs first.

